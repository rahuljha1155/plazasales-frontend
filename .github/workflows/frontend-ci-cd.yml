name: Frontend CI/CD

on:
  push:
    branches:
      - main

concurrency:
  group: frontend-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME: rahuljha1155/plaza-frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute image tag
        id: meta
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          build-args: |
            NEXT_PUBLIC_API_URL=https://app.plazasales.com.np/api/v1/plaza
            NEXT_PUBLIC_RECAPTCHA_SITE_KEY=6LeC4AEsAAAAACosF5XfvpZIiKGA2zTfkO4a_eNQ
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:sha-${{ steps.meta.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          provenance: false

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -euo pipefail

            # Variables
            IMAGE_NAME="rahuljha1155/plaza-frontend"
            SHORT_SHA="${GITHUB_SHA::7}"
            IMAGE_TAG="sha-${SHORT_SHA}"
            DEPLOY_DIR="/var/www/plazasales-frontend"

            echo "ğŸš€ Starting deployment..."
            echo "Image: ${IMAGE_NAME}:${IMAGE_TAG}"

            # Navigate to deploy directory
            cd "${DEPLOY_DIR}"
            echo "Current directory: $(pwd)"

            # Pull the new Docker images
            echo "ğŸ“¦ Pulling Docker images..."
            docker pull "${IMAGE_NAME}:${IMAGE_TAG}"
            docker pull "${IMAGE_NAME}:latest"

            # Stop and remove existing container if it exists
            echo "ğŸ›‘ Checking for existing container..."
            if docker ps -a --format "{{.Names}}" | grep -q "^plazasales-frontend$"; then
              echo "Stopping existing container..."
              docker stop plazasales-frontend || true
              docker rm plazasales-frontend || true
              echo "Existing container removed."
            else
              echo "No existing container found."
            fi

            # Run new container
            echo "ğŸš€ Starting new container..."
            docker run -d \
              --name plazasales-frontend \
              --restart unless-stopped \
              -p 127.0.0.1:2661:2661 \
              -e NEXT_PUBLIC_API_URL=https://app.plazasales.com.np/api/v1/plaza \
              -e NEXT_PUBLIC_RECAPTCHA_SITE_KEY=6LeC4AEsAAAAACosF5XfvpZIiKGA2zTfkO4a_eNQ \
              -e NODE_ENV=production \
              "${IMAGE_NAME}:${IMAGE_TAG}"

            # Wait for container to start
            echo "â³ Waiting for container to start..."
            sleep 10

            # Check if container is running
            echo "ğŸ” Checking container status..."
            if docker ps --format "{{.Names}} {{.Status}}" | grep -q "plazasales-frontend"; then
              echo "âœ… Container is running!"
              
              # Check logs for errors
              echo "ğŸ“‹ Checking container logs..."
              docker logs plazasales-frontend --tail 20
              
              # Simple health check
              echo "ğŸ§ª Testing application..."
              if curl -s -f http://localhost:2661 > /dev/null; then
                echo "âœ… Application is responding!"
              else
                echo "âš ï¸  Application might need more time to start..."
                # Give it more time and try again
                sleep 20
                if curl -s -f http://localhost:2661 > /dev/null; then
                  echo "âœ… Application is now responding!"
                else
                  echo "âŒ Application failed to start. Check logs."
                  docker logs plazasales-frontend
                fi
              fi
            else
              echo "âŒ Container failed to start. Checking logs..."
              docker logs plazasales-frontend || true
              exit 1
            fi

            # Clean up old Docker images
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f

            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸŒ Application is running on port 2661"
