name: Plazasales Frontend CI/CD (VPS)

on:
  push:
    branches: ["master","main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  IMAGE_NAME: rahuljha1155/plaza-frontend
  REMOTE_DIR: /var/www/plazasales-frontend
  COMPOSE_FILE: docker-compose.frontend.yml

jobs:
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.vars.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image tag
        id: vars
        run: echo "tag=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          platforms: linux/amd64
          provenance: false
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:cache
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:cache,mode=max
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }}

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    env:
      TAG: ${{ needs.build-and-push.outputs.image_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set SSH port
        run: echo "PORT=${{ secrets.VPS_PORT || '22' }}" >> $GITHUB_ENV

      - name: Prepare SSH key
        run: |
          install -m 700 -d ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Ensure remote directory exists
        run: |
          ssh -i ~/.ssh/id_rsa -p "$PORT" -o BatchMode=yes -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "bash --noprofile --norc -c 'mkdir -p \"${{ env.REMOTE_DIR }}\"'"

      - name: Upload compose file
        run: |
          scp -i ~/.ssh/id_rsa -P "$PORT" -o BatchMode=yes -o StrictHostKeyChecking=no \
            ${{ env.COMPOSE_FILE }} \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:'${{ env.REMOTE_DIR }}/${{ env.COMPOSE_FILE }}'

      - name: SSH and deploy on VPS
        run: |
          ssh -i ~/.ssh/id_rsa -p "$PORT" -o BatchMode=yes -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "bash --noprofile --norc -c '
              set -euo pipefail
              echo \"Deploying tag: ${{ env.TAG }}\"
              sudo systemctl is-active --quiet docker || sudo systemctl start docker
              if docker compose version >/dev/null 2>&1; then
                COMPOSE_CMD=(docker compose)
              else
                COMPOSE_CMD=(docker-compose)
              fi
              docker network inspect plaza-network >/dev/null 2>&1 || docker network create plaza-network
              cd \"${{ env.REMOTE_DIR }}\"
              export TAG=\"${{ env.TAG }}\"
              export IMAGE_NAME=\"${{ env.IMAGE_NAME }}\"
              docker pull \"${{ env.IMAGE_NAME }}:${{ env.TAG }}\"
              \"${COMPOSE_CMD[@]}\" -f \"${{ env.COMPOSE_FILE }}\" pull plazasales-frontend
              \"${COMPOSE_CMD[@]}\" -f \"${{ env.COMPOSE_FILE }}\" up -d --no-deps plazasales-frontend
              docker ps
              for i in {1..10}; do
                if curl -fsS http://127.0.0.1:2661/ >/dev/null; then
                  echo \"Health check passed\"
                  break
                fi
                echo \"Waiting for health check...\"
                sleep 3
              done
              curl -fsS http://127.0.0.1:2661/ >/dev/null
              docker image prune -a -f --filter \"until=24h\"
            '"
