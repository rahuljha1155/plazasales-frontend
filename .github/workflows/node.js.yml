name: Plazasales Frontend CI/CD (VPS)

on:
  push:
    branches: ["master","main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  IMAGE_NAME: rahuljha1155/plaza-frontend
  REMOTE_DIR: /var/www/plazasales-frontend
  COMPOSE_FILE: docker-compose.frontend.yml

jobs:
  deploy:
    name: Build & Deploy on VPS
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    env:
      TAG: ${{ github.sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create source archive (exclude .env)
        run: |
          tar --exclude=.env --exclude=.git --exclude=node_modules -czf /tmp/app.tgz .

      - name: Set SSH port
        run: echo "PORT=${{ secrets.VPS_PORT || '22' }}" >> $GITHUB_ENV

      - name: Prepare SSH key
        run: |
          install -m 700 -d ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Ensure remote directory exists
        run: |
          ssh -i ~/.ssh/id_rsa -p "$PORT" -o BatchMode=yes -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "bash --noprofile --norc -c 'mkdir -p \"${{ env.REMOTE_DIR }}\"'"

      - name: Upload source archive
        run: |
          scp -i ~/.ssh/id_rsa -P "$PORT" -o BatchMode=yes -o StrictHostKeyChecking=no \
            /tmp/app.tgz \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:'${{ env.REMOTE_DIR }}/app.tgz'

      - name: Upload compose file
        run: |
          scp -i ~/.ssh/id_rsa -P "$PORT" -o BatchMode=yes -o StrictHostKeyChecking=no \
            ${{ env.COMPOSE_FILE }} \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:'${{ env.REMOTE_DIR }}/${{ env.COMPOSE_FILE }}'

      - name: SSH and deploy on VPS
        run: |
          ssh -i ~/.ssh/id_rsa -p "$PORT" -o BatchMode=yes -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "bash --noprofile --norc -c '
              set -euo pipefail
              echo \"Deploying tag: ${{ env.TAG }}\"
              sudo systemctl is-active --quiet docker || sudo systemctl start docker
              if docker compose version >/dev/null 2>&1; then
                COMPOSE_CMD=(docker compose)
              else
                COMPOSE_CMD=(docker-compose)
              fi
              docker network inspect plaza-network >/dev/null 2>&1 || docker network create plaza-network
              cd \"${{ env.REMOTE_DIR }}\"
              tar -xzf app.tgz -C \"${{ env.REMOTE_DIR }}\"
              rm -f app.tgz
              export TAG=\"${{ env.TAG }}\"
              export IMAGE_NAME=\"${{ env.IMAGE_NAME }}\"
              docker build -t \"${{ env.IMAGE_NAME }}:${{ env.TAG }}\" .
              \"${COMPOSE_CMD[@]}\" -f \"${{ env.COMPOSE_FILE }}\" pull plazasales-frontend
              \"${COMPOSE_CMD[@]}\" -f \"${{ env.COMPOSE_FILE }}\" up -d --no-deps plazasales-frontend
              docker ps
              for i in {1..10}; do
                if curl -fsS http://127.0.0.1:2661/ >/dev/null; then
                  echo \"Health check passed\"
                  break
                fi
                echo \"Waiting for health check...\"
                sleep 3
              done
              curl -fsS http://127.0.0.1:2661/ >/dev/null
              docker image prune -a -f --filter \"until=24h\"
            '"
